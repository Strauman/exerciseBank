
%\BDOC
% §env=Environments
% §lang=Internationalization
% §triggers=Triggers
% §ref=General reference
% §makingSets=Making sets
% §count=Counters
%\EDOC
%!TEX root = main.tex
%\BDOC
%§ref
%\ownLineNoSpacesGotIt
% This is to annoy the user enough to get his attention about the requirements of the \!refEnv{problem}, \!refEnv{solution} and \!refEnv{intro} environments.\\
% Compilation wont work unless \end{problem}, \end{solution} and \end{intro} are on their own lines and without any spaces. This warning can be removed by doing \def\ownLineNoSpacesGotIt{} before \usepackage{exbank}.
%\EDOC
\makeatletter
\@ifundefined{ownLineNoSpacesGotIt}{
\@latex@warning{Compilation wont work unless \string\end{problem} and \string\end{solution} are on their own lines and without any spaces. This warning can be removed by doing \string\def\string\ownLineNoSpacesGotIt{} before \string\usepackage{exbank}}
}{}
% \BDOC
%\setExercisesDir{directory}
% This is the directory, relative to the file you included the package,
% where the package should be looking for exercises. Default is \!texttt{exercises}
% \EDOC
\gdef\setExercisesDir#1{\gdef\exercisesDir{#1}}

\@ifundefined{exercisesDir}{
\gdef\exercisesDir{exercises}
}{}
\makeatother


\global\let\incl = \input
%!TEX root = main.tex
\usepackage{xstring}
\usepackage{pgffor}
\usepackage{scrextend}
\usepackage{comment}
\usepackage{calc}
 %!TEX root = main.tex
\makeatletter
\pgfkeys{
 /exbanki18n/.is family, /exbanki18n,
  default/.style = {Problem = Problem, Solution = Solution},
  Problem/.estore in = \@tr@Problem,
  Solution/.estore in = \@tr@Solution
}
% \BDOC
%§lang
%\translateExBank{Translation key/vals}
% This is to translate the text inside the package. As of now the available key/values are
%\!begin{itemize}
%\!item Problem
%\!item Solution
%\!end{itemize}
% \EDOC
%\BDOC
% The Norwegian translation would then be done with
%\EDOC
% \BEX
% \translateExBank{Problem=Oppgave, Solution=Løsning}
% \EEX
\newcommand{\translateExBank}[1]{
  \pgfkeys{/exbanki18n, default, #1}%
}
\translateExBank{}

%
\gdef\@tr#1{
\@ifundefined{@tr@#1}{#1}{
  \csname @tr@#1\endcsname
}
}
\makeatother
 %!TEX root = main.tex
%\BDOC
%§ref
%\EDOC
\makeatletter
%% Adds macro to queue
\let\ea = \expandafter
\def\removebs#1{\if#1\@backslashchar\else#1\fi}
%\BDOC
% This package also includes some extra stuff. For example the \At and \Trigger
%\EDOC
%\BDOC
%\At{AnyMacro}
%Here you can send any macro because it isn't evaluated! For example \At\BeginSomething is fine and even if \BeginSomething is not defined. Also and when using \Trigger it just ignores it if it didn't exist. It's pretty similar in function as to \AtBeginDocument.
%\EDOC
%\BEX
%\At\BeginSomething{DoSomething}
% Which is triggered with
% \Trigger\BeginSomething, this evaluates to DoSomething
%\EEX
%% Usage: \At\BeginSomething (\BeginSomething) doesn't have to be defined
\newcommand{\At}[2]{
  \def\macname{\expandafter\removebs\detokenize{#1}}
  \let\mname = \macname
  \ifcsname At@\mname\endcsname
    \ea\g@addto@macro\csname At@\mname\endcsname{#2}
  \else
    \ea\gdef\csname At@\mname\endcsname{#2}
  \fi
}
%% Triggers queue generated by \At
%% Usage: \Trigger\BeginSomething (\BeginSomething) doesn't have to be defined
% \BDOC
%\Trigger{Any Macro}
% See \refCom{At}\\
%Available triggers:\\
%§triggers
% !!triggers
% \EDOC
\newcommand{\Trigger}[1]{
  \def\macname{\expandafter\removebs\detokenize{#1}}
  \let\mname = \macname
  \@ifundefined{At@\mname}{}{\csname At@\mname\endcsname}
  % \ifcsname At@\mname\endcsname
  %   % \begingroup
  %   \makeatletter
  %   \csname At@\mname\endcsname
  %   \makeatother
  %   % \endgroup
  % \fi
}
\makeatother
 \long\def\about#1{}
 %!TEX root = main.tex
\makeatletter
\def\ppLeading{4em}
\def\pMarginBelow{1em}
\def\pMarginAbove{1em}
\def\pMarginLeft{-1.5em}
\def\ppMargin{1em}
\def\solMargin{\dimexpr \ppMargin+\ppMargin\relax}
\def\vsSize{1em}
\def\vs{\vspace{\vsSize}}
%\BDOC
%§count
%\!docCounter{problemcounter}-counter holds the current problem number and
%\!docCounter{partproblemcounter}-counter holds the current partproblem \!emph{number}.
%\EDOC
\newcounter{problemcounter}
\setcounter{problemcounter}{0}
\newcounter{partproblemcounter}

\At\VeryBeginProblem{
  \stepcounter{problemcounter}
  \setcounter{partproblemcounter}{1}
  \vspace*{\pMarginAbove}
  \begin{addmargin}{\pMarginLeft}
    {\normalfont\Large\bfseries\@tr{Problem}~\theproblemcounter}
  \end{addmargin}
  \vspace*{\pMarginBelow}
}
\At\BeginPartproblem{
	\vspace{\ppMargin}%
	 \begin{addmargin}{\ppMargin}%
\large\hspace*{-\ppMargin}\textbf{(\theproblemcounter\alph{partproblemcounter})}\normalsize
\makeatletter
  \stepcounter{partproblemcounter}
}
\At\EndPartproblem{\hfill
\end{addmargin}\vspace*{0.5em}
}
\At\BeginSolution{
  \vspace*{1em}
  \begin{addmargin}{\solMargin}%
\hspace*{-\solMargin}\large{\textbf{\@tr{Solution}:}}\normalsize
}
\At\EndSolution{
  \end{addmargin}\vspace*{1em}
}
 %!TEX root = main.tex

\makeatletter

\gdef\isFalse{0}
\gdef\isTrue{1}
\gdef\DisplayProblem{\isTrue}
\gdef\@displayMetaCounter{\isFalse}

\gdef\ShowNumbers{\gdef\@displayMetaCounter{\isTrue}}

%%%% NB: Difference between \DisplaySolution and \DisplaySolutions
\gdef\@DisplaySolutions{\isFalse}
%%NB: DOC for \DisplaySolutions are moved down
\gdef\DisplaySolutions{\xdef\@DisplaySolutions{\isTrue}\@latex@warning{Showing solutions}}
\AtBeginDocument{
  \if\@DisplaySolutions\isFalse
    \@latex@warning{Hiding solutions. Show them with \string\DisplaySolutions}
  \fi
}
\global\let\do@ProcessCutFile = \ProcessCutFile
%% Problems
\gdef\showhideproblem#1{%
  \if\@displayMetaCounter\isTrue%
    {P:\Large\themetacounter}
    \Trigger\BeginPartproblem
    \gdef\DisplayProblem{\isTrue}
  \else
    \if\DisplayProblem\isFalse
      \def\ProcessCutFile{}
    \else
      #1
    \fi
  \fi
}

% \BDOC!
%§env
% \\begin{problem}
% Inside the exercises folder, you keep your exercises. Inside there you'd use a problem environment to write your partproblems. It might be a little confusing that you're using \begin{problem} instead of \begin{partproblem} when you're writing a partproblem, but it's less typing.
%\!begin{marker}\end{problem} has to be on it's own line without any leading spaces!\!end{marker}
% \EDOC
\generalcomment{problem}{
  %%%% NB: Difference between \DisplaySolution and \DisplaySolutions
  \edef\DisplaySolution{\@DisplaySolutions}
  %% BeginPartproblemHard is before regardless whether
  %% the problem is included or not.
  \Trigger\DecideProblemDisplay
  \begingroup
     \showhideproblem{\Trigger\BeginPartproblem}
  }{
    \if\DisplayProblem\isFalse\else
      \Trigger\EndPartproblem
    \fi
  \endgroup
}
% \BDOC!
%§env
% \\begin{solution}
% Things inside here is only visible if \refCom{DisplaySolutions} are given before \begin{document}
%\!begin{marker}\end{solution} has to be on it's own line without any leading spaces!\!end{marker}
% \EDOC
% \BDOC!
% \DisplaySolutions
% Turns on the solutions, so they are shown.
% \EDOC
%% Solutions
\generalcomment{solution}
{
\Trigger\AtBeginSolutionHard
\begingroup
  \if\@DisplaySolutions\isTrue
    \if\DisplayProblem\isFalse
      \xdef\DisplaySolution{\isFalse}
    \fi
  \fi
  % \inspw{\DisplaySolution}
  \if\DisplaySolution\isTrue
    \Trigger\BeginSolution
  \else
    \def\ProcessCutFile{}
  % \begingroup
  % \edef\tmp{\def\noexpand\CommentCutFile{answer.tex}}
  % \tmp
    % \def\ProcessCutFile{\do@ProcessCutFile}
  \fi
}{
% \input{\CommentCutFile}
\if\DisplaySolution\isTrue
\Trigger\EndSolution
\fi

\Trigger\EndSolutionHard
\endgroup
}
%% Problem introductions
%\BDOC!
%§env
%\\begin{intro}
% Sometimes you'd want to introcude your exercises and tell a little bit about it. Maybe have a figure there also. Those things should go inside this environment. This can be treated as a problem in terms of counting. See \refCom{makeset} for more info.
%\!begin{marker}\end{intro} has to be on it's own line without any leading spaces!\!end{marker}
% \EDOC
\generalcomment{intro}{
  %% Decide wether to treat intro as problem in
  %% include/exclude (except from \Trigger\BeginProblem ofc)
  \if\@countIntros\isTrue
    \Trigger\DecideProblemDisplay
    \begingroup
    \showhideproblem{\Trigger\BeginIntro}
  \fi
}{
  \if\@countIntros\isTrue
    \Trigger\EndIntro
    \endgroup
  \fi
}
 %\BDOC
%§ref
%\isin{haystack}{needle}{True}{False}
% \meta{haystack} is a comma separated list of integers\\
% \meta{needle} is an integer\\
% Executes \meta{True} if \meta{needle} is found in \meta{haystack}
% else executes \meta{False}
%\EDOC
% #1: haystack
% #2: needle
% #3: action if found in list
% #4: action if not found in list
\gdef\isin#1#2#3#4{
  \def\needle{#2}
  \def\haystack{#1}
  \def\isFalse{0}
  \let\isInList = \isFalse
  \IfInteger{\haystack}{
    \if\haystack\needle
    #3
    \else
    #4
    \fi
  }{
  \foreach \pp in #1{
    \if\pp\needle
      \gdef\isInList{1}
      #3
    \fi
  }
  \if\isInList\isFalse
    #4
  \fi
  }
}
 %!TEX root = main.tex
%\BDOC
%§makingSets
%\EDOC
\let\ea = \expandafter
\newcounter{metacounter}
\def\emptyList{-1}

\begingroup\lccode`\|=`\\
\lowercase{\endgroup\def\removebs#1{\if#1|\else#1\fi}}
\newcommand{\macroname}[1]{\expandafter\removebs\string#1}

\gdef\ifppMode#1{
  \def\mname{\macroname{#1}}
  \if\mname\ppMode
}
\gdef\isppMode#1#2{
  \edef\mname{\macroname{#1}}
  \if{\macroname{#1}}\ppMode#2\fi
}
\gdef\@noneofone#1{}
\gdef\@noneOfTwo#1#2{}

%%% NOT WORKING
\gdef\@ifppMode#1{%
% \edef\mname{\macroname{#1}}
\ifnum\pdfstrcmp{\macroname{#1}}{\ppMode}=\z@%
\expandafter\@firstofone%
\else%
\expandafter\@noneofone%
\fi%
}%
\def\pm@Exclude{exclude}
\def\pm@Select{select}

%% Deciding whether problem (and accompanied solution) should be shown
\let\ipm\@ifppMode
\let\T\isTrue
\let\F\isFalse
\At\DecideProblemDisplay{
  \if\ppList\emptyList
    \xdef\DisplayProblem{\ipm\exclude\T\ipm\select\F}
  \else
    \isin{\ppList}{\themetacounter}{
      \xdef\DisplayProblem{\ipm\exclude\F\ipm\select\T\ipm\normal\T}
    }{
      \xdef\DisplayProblem{\ipm\exclude\T\ipm\select\F\ipm\normal\T}
    }
  \fi
  % \inspw\DisplayProblem
  \stepcounter{metacounter}
}

%% Makeset arg handler
\pgfkeys{
 /makeset/.is family, /makeset,
 default/.style = {noheadarg=\isFalse, introarg=\isFalse},
 intro/.style = {introarg=\isTrue},
 nohead/.style = {noheadarg=\isTrue},
 introarg/.estore in = \introarg,
 noheadarg/.estore in = \noheadarg
}

%% Generates sets that can be iterated over
%% \makeset[intro|nohead]{\select{path/to/file}{1,2}, \exclude{file}{1,2}, file}
%% Where file is a file in the \exerciseDir-folder and 1,2 are the part problem numbers
%\BDOC!
%\makeset[intro,nohead]{filable}
% This command is the one you use to make a set! Later you use \buildset to build the sets you make. The \meta{filable} argument is either the name of the file relative to the \exerciseDir-path (default its in the root called exercises), or you could use the \select or \exclude to  respectively cherry pick or exclude exercises. (See their docs).\\
% \oarg{intro} this counts the intro environment as a part problem, so that you can \select or \exclude the intro\\
% \oarg{nohead} prevents the builder from adding a problem header. This is handy if you want to create an exercise that is composed of multiple parts. You can use the \phead to insert the problem header where you want it
%\EDOC
%\BEX!
% \makeset[nohead]\{\phead, \select{myexercise}\{1,2,3\}\}
%\EEX
\newcommand\makeset[3][]{
  \pgfkeys{/makeset, default, #1}%
  % Is intro sent?
  \if\introarg\isTrue%
    \ea\gdef\csname setlist@#2@intro\endcsname{\isTrue}
  \fi
  \if\noheadarg\isTrue%
    \ea\gdef\csname setlist@#2@nohead\endcsname{\isTrue}
  \fi
  \ea\gdef\csname setlist@#2\endcsname{#3}
}
%% Sets the variables \ppList and \exerciseFile based on the current set
\newcommand{\redef}[3][{-1}]{
  \gdef\ppList{#1}
  \gdef\exerciseFile{#2}
  \gdef\ppMode{#3}
}
%% Converts {A}{1,2,3} into [{1,2,3}]{A}{exclude} such that it can be sent
%% as optional arguments to redef. The last is set as ppMode (exclude/select/mix)
% \BDOC!
%\exclude{exerciseFileName}{Comma separated numbers}
%As you can see in the intro section of the documentation, this is for excluding partproblems
%To be used in \refCom{makeset}
% \EDOC
\newcommand{\exclude}[2]{[{#2}]{#1}{exclude}}

% \BDOC!
%\select{exerciseFileName}{Comma separated numbers}
%As you can see in the intro section of the documentation, this is for cherry picking partproblems
%To be used in \refCom{makeset}
% \EDOC
\newcommand{\select}[2]{[{#2}]{#1}{select}}

%% Build one exercise
\gdef\buildex#1{
  \makeset{#1}{#1}
  \buildset{#1}
}
%%Logic for building a set
\gdef\@countIntros{\isFalse}
\gdef\phead{?\noexpand\Trigger\noexpand\VeryBeginProblem}
\newcommand\buildset[2][]{
  \def\oarg{#1}
  % \def\argToShowIntro{intro}
  \@ifundefined{setlist@#2@intro}{\gdef\@countIntros{\isFalse}}{\gdef\@countIntros{\isTrue}\@latex@warning{Counting intros}}
  \@ifundefined{setlist@#2@nohead}{\gdef\nohead{\isFalse}}{\gdef\nohead{\isTrue}}
  %% Setting the global setName
  \xdef\setName{#2}
  %% Warnins if the set doesn't exist
  \@ifundefined{setlist@#2}{
    \@latex@error{Couldn't find set #2. Did you remember to do \string\makeset{#2}{}? }
    \stop
  }{}
  %% Sets the current setlist from the variable
  %% generated in makeset
  \edef\setlist{\csname setlist@#2\endcsname}
  \Trigger\StartBuildset
  %% Loop through list
  \foreach \exerciseFileInfo in \setlist{
    \def\continueLoop{\isTrue}
    % \inspw\exerciseFileInfo
    %% ppList is -1 if it's not a list
    \gdef\ppList{-1}
    %% Counter used for iterating over partproblems
    %% (Cant' use partproblemcounter since some of them might be excluded)
    \setcounter{metacounter}{1}
    %% Checking whether we have optional args
    %% I.e. one of the arguments are sent via \exclude
    %% And then send it to \redef
    \StrLeft{\exerciseFileInfo}{1}[\firstchar]%
    \if[\firstchar
      \ea\redef\exerciseFileInfo\relax
      \def\continueLoop{\isTrue}
    \else\if?\firstchar
        \expandafter\@secondoftwo\exerciseFileInfo
      \def\continueLoop{\isFalse}
    \else
        \redef{\exerciseFileInfo}{normal}
        \def\continueLoop{\isTrue}
    \fi\fi
    \if\continueLoop\isTrue

    %% TRIGGER EVERTYHING
%\Trigger\InputExercise:Triggers before a file is included
%\Trigger\BeginProblem:Triggers before a file is included, but only if problem headers are to be written (no [nohead] given)
    \Trigger\InputExercise
    \if\nohead\isFalse\Trigger\BeginProblem\fi
    %% \VeryBeginProblem is only for stuff that
    %% is intended to be a part of the problem
    %% e.g. problem header is using this.
    \if\nohead\isFalse\Trigger\VeryBeginProblem\fi
    % \inspw\nohead
    %% \incl = \ input because otherwise latexpanded would try.
    %% to input the file
    \incl{\exercisesDir/\exerciseFile}
    %% More triggers
%\Trigger\EndProblem:Triggers right after problem is included if [nohead] \emph{not} given
    \if\nohead\isFalse\Trigger\EndProblem\fi
    \fi
  }
  \Trigger\EndBuildset
}
 %!TEX root = ../main.tex
%% Reference problems
%\BDOC
%§makingSets
%\EDOC
\newcommand\refcounter[1]{
\edef\@currentlabel{#1}%
}
%\BDOC
%\pplabel{label}
% Labels a partproblem. You can reference to it later using \ppref{\meta{label}}
%\EDOC
\DeclareRobustCommand{\pplabel}[1]{
	\refcounter{\theproblemcounter}\label{pr:\exerciseFile:#1}
	\refcounter{\thepartproblemcounter}\label{pp:\exerciseFile:#1}
}

\let\pptag = \pplabel
\newcommand\pppref[1]{%
(\ref{pp:\exerciseFile:#1})\relax%
}
%\BDOC
%\ppref{label}
% Reference a partproblem created by \pplabel{\meta{label}}. This prints e.g. 1c)
%\EDOC
\newcommand\ppref[1]{%
\ref{pr:\exerciseFile:#1}\ref{pp:\exerciseFile:#1}\relax%
}
%\BDOC
%\ppref{label}
% Reference a partproblem created by \pplabel{\meta{label}}. This prints e.g. 1
%\EDOC
\newcommand\pref[1]{%
\ref{pr:\exerciseFile:#1}\relax%
}
  