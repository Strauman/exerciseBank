%!TEX root = main.tex
\let\ea = \expandafter
\newcounter{metacounter}
\def\emptyList{-1}

\begingroup\lccode`\|=`\\
\lowercase{\endgroup\def\removebs#1{\if#1|\else#1\fi}}
\newcommand{\macroname}[1]{\expandafter\removebs\string#1}

\gdef\ifppMode#1{
  \def\mname{\macroname{#1}}
  \if\mname\ppMode
}
\gdef\isppMode#1#2{
  \edef\mname{\macroname{#1}}
  \if{\macroname{#1}}\ppMode#2\fi
}
\gdef\@noneOfOne#1{}
\gdef\@noneOfTwo#1#2{}
\gdef\@ifppMode#1#2{%
% \edef\mname{\macroname{#1}}
\if{\macroname{#1}}\ppMode%
\expandafter\@secondoftwo%
\else%
\expandafter\@noneOfTwo%
\fi%
}%
%% Deciding whether problem (and accompanied solution) should be shown
\At\DecideProblemDisplay{
  \if\ppList\emptyList
    \xdef\DisplayProblem{\@ifppMode\exclude\isTrue\@ifppMode\select\isFalse}
  \else
    \isin{\ppList}{\themetacounter}{
      \xdef\DisplayProblem{\@ifppMode\exclude\isFalse\@ifppMode\select\isTrue}
    }{
      \xdef\DisplayProblem{\@ifppMode\exclude\isTrue\@ifppMode\select\isFalse}
    }
    \stepcounter{metacounter}
  \fi
  % \inspw\DisplayProblem
}
%% Generates sets that can be iterated over
\gdef\makeset#1#2{
  \ea\gdef\csname setlist@#1\endcsname{#2}
}
%% Sets the variables \ppList and \exerciseFile based on the current set
\newcommand{\redef}[3][{-1}]{
  \gdef\ppList{#1}
  \gdef\exerciseFile{#2}
  \gdef\ppMode{#3}
}
%% Converts {A}{1,2,3} into [{1,2,3}]{A}{exclude} such that it can be sent
%% as optional arguments to redef. The last is set as ppMode (exclude/select/mix)
\newcommand{\exclude}[2]{[{#2}]{#1}{exclude}}
\newcommand{\select}[2]{[{#2}]{#1}{select}}

%% Build one exercise
\gdef\buildex#1{
  \makeset{#1}{#1}
  \buildset{#1}
}
%%Logic for building a set
\gdef\buildset#1{
  %% Setting the global setName
  \xdef\setName{#1}
  %% Warnins if the set doesn't exist
  \@ifundefined{setlist@#1}{
    \@latex@error{Couldn't find set #1. Did you remember to do \string\makeset{#1}{}? }
    \stop
  }{}
  %% Sets the current setlist from the variable
  %% generated in makeset
  \edef\setlist{\csname setlist@#1\endcsname}
  \Trigger\StartBuildset
  %% Loop through list
  \foreach \exerciseFileInfo in \setlist{
    \inspw\exerciseFileInfo
    %% ppList is -1 if it's not a list
    \gdef\ppList{-1}
    %% Counter used for iterating over partproblems
    %% (Cant' use partproblemcounter since some of them might be excluded)
    \setcounter{metacounter}{1}
    %% Checking whether we have optional args
    %% I.e. one of the arguments are sent via \exclude
    %% And then send it to \redef
    \StrLeft{\exerciseFileInfo}{1}[\firstchar]%
    \if[\firstchar
      \ea\redef\exerciseFileInfo\relax
    \else
      \redef{\exerciseFileInfo}{norm}
    \fi
    %% TRIGGER EVERTYHING
    \Trigger\InputExercise
    \Trigger\BeginProblem
    %% The two above are meant to be aliases
    %% The one below \VeryBeginProblem is only for stuff that
    %% is intended to be a part of the problem
    %% e.g. problem header is using this.
    \Trigger\VeryBeginProblem
    %% \incl = \input because otherwise latexpanded would try.
    %% to input the file
    \incl{\exercisesDir/\exerciseFile}
    %% More triggers
    \Trigger\EndProblem
    \Trigger\EndInputExercise
  }
  \Trigger\EndBuildset
}
