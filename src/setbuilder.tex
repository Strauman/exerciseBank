%!TEX root = main.tex
% This file contains the logic of the set making and set building.
% It also decides whether or not a problem,intro and/or solution
% should be built
%:§makingSets
%:-
\let\ea = \expandafter
\newcounter{metacounter}
\def\emptyList{-1}

\begingroup\lccode`\|=`\\
\lowercase{\endgroup\def\removebs#1{\if#1|\else#1\fi}}
\newcommand{\macroname}[1]{\expandafter\removebs\string#1}

\gdef\ifppMode#1{
  \def\mname{\macroname{#1}}
  \if\mname\ppMode
}
\gdef\isppMode#1#2{
  \edef\mname{\macroname{#1}}
  \if{\macroname{#1}}\ppMode#2\fi
}
\gdef\@noneofone#1{}
\gdef\@noneOfTwo#1#2{}

%%% NOT WORKING
\gdef\@ifppMode#1{%
% \edef\mname{\macroname{#1}}
\ifnum\pdfstrcmp{\macroname{#1}}{\ppMode}=\z@%
\expandafter\@firstofone%
\else%
\expandafter\@noneofone%
\fi%
}%
\def\pm@Exclude{exclude}
\def\pm@Select{select}

%% Deciding whether problem (and accompanied solution) should be shown
\let\ipm\@ifppMode
\let\T@\isTrue
\let\F@\isFalse
\At\DecideProblemDisplay{
  \if\ppList\emptyList
    \xdef\DisplayProblem{\ipm\exclude\T@\ipm\select\F@}
  \else
    \isin{\ppList}{\themetacounter}{
      \xdef\DisplayProblem{\ipm\exclude\F@\ipm\select\T@\ipm\normal\T@}
    }{
      \xdef\DisplayProblem{\ipm\exclude\T@\ipm\select\F@\ipm\normal\T@}
    }
  \fi
  % \inspw\DisplayProblem
  \stepcounter{metacounter}
}

%% Makeset arg handler
\pgfkeys{
 /makeset/.is family, /makeset,
 default/.style = {noheadarg=\isFalse, introarg=\isFalse},
 intro/.style = {introarg=\isTrue},
 nohead/.style = {noheadarg=\isTrue},
 introarg/.estore in = \introarg,
 noheadarg/.estore in = \noheadarg
}
\gdef\@listOfSets{}
\gdef\@spriteMode{\isFalse}
%% Generates sets that can be iterated over
%% \makeset[intro|nohead]{\select{path/to/file}{1,2}, \exclude{file}{1,2}, file}
%% Where file is a file in the \exerciseDir-folder and 1,2 are the part problem numbers
%:=\makeset[intro,nohead]{filable}
%: This command is the one you use to make a set! Later you use \buildset to build the sets you make. The \meta{filable} argument is either the name of the file relative to the \exerciseDir-path (default its in the root called exercises), or you could use the \select or \exclude to  respectively cherry pick or exclude exercises. (See their docs).\\
%: \oarg{intro} this counts the intro environment as a part problem, so that you can \select or \exclude the intro\\
%: \oarg{nohead} prevents the builder from adding a problem header. This is handy if you want to create an exercise that is composed of multiple parts. You can use the \phead to insert the problem header where you want it
%:! \makeset[nohead]\{\phead, \select{myexercise}{1,2,3}}
%:-
\newcommand\makeset[3][]{
  \pgfkeys{/makeset, default, #1}%
  % Is intro sent?
  \if\introarg\isTrue%
    \ea\gdef\csname setlist@#2@intro\endcsname{\isTrue}
  \fi
  \if\noheadarg\isTrue%
    \ea\gdef\csname setlist@#2@nohead\endcsname{\isTrue}
  \fi
  \ea\gdef\csname setlist@#2\endcsname{#3}
  \def\setmacro{\unexpanded\expandafter{\csname setlist@#2\endcsname}}
  % \g@addto@macro\@listOfSets{\csname setlist@#2\endcsname,}
  \g@addto@macro\@listOfSets{#2}
}
%:=\about{text}
%:This contains information about an exercise set. It is intended to be on the top of an
%:exercise, explaining short what the exercise is about. It's only visible when using \sprite
%:-
%% It gets defined in \sprite when use
\long\gdef\about#1{}

%:=\sprite[PiP]
%: This is a way to visualize all exercises. It takes one optional argument which is how many pages
%: inside one page. Defaults to 4
%: \!begin{marker}If \sprite is used, it should be the only command in \begin{document}\end{document}\!end{marker}
%:-
\newcommand\sprite[1][4]{
\squeeze
\gdef\@spriteMode{\isTrue}
\long\def\about##1{{\Large\textbf{About}:\\[1.1em]##1\\[1.5em]}}
\pgfpagesuselayout{#1 on 1}[a4paper,border shrink=5mm]
  \foreach \set in \@listOfSets{
    \buildset{\set}
  }
}
%:§ref
%:=\exerciseFile
%:This is a `read-only' macro that contains the name of the current exerciseFile
%:-
%:§makingSets
%% Sets the variables \ppList and \exerciseFile based on the current set
\newcommand{\redef}[3][{-1}]{
  \if\@spriteMode\isFalse%
    \gdef\ppList{#1}
    \gdef\exerciseFile{#2}
    \gdef\ppMode{#3}
  \else
    \gdef\ppList{}
    \gdef\exerciseFile{#2}
    \gdef\ppMode{exclude}
\fi

}
%% Converts {A}{1,2,3} into [{1,2,3}]{A}{exclude} such that it can be sent
%% as optional arguments to redef. The last is set as ppMode (exclude/select/mix)
%:=\exclude{exerciseFileName}{Comma separated numbers}
%:As you can see in the intro section of the documentation, this is for excluding partproblems
%:To be used in \refCom{makeset}
% :-
\newcommand{\exclude}[2]{[{#2}]{#1}{exclude}}

%:=\select{exerciseFileName}{Comma separated numbers}
%:As you can see in the intro section of the documentation, this is for cherry picking partproblems
%:To be used in \refCom{makeset}
% :-
\newcommand{\select}[2]{[{#2}]{#1}{select}}

%% Build one exercise
\gdef\buildex#1{
  \makeset{#1}{#1}
  \buildset{#1}
}
%%Logic for building a set
\gdef\@countIntros{\isFalse}
\gdef\phead{?\noexpand\Trigger\noexpand\VeryBeginProblem}
\newcommand\buildset[2][]{
  \def\oarg{#1}
  % \def\argToShowIntro{intro}
  \@ifundefined{setlist@#2@intro}{\gdef\@countIntros{\isFalse}}{\gdef\@countIntros{\isTrue}\@latex@warning{Counting intros}}
  \@ifundefined{setlist@#2@nohead}{\gdef\nohead{\isFalse}}{\gdef\nohead{\isTrue}}
  %% Setting the global setName
%:=\setName
%:This variable prints out the name of your set that you sent to \buildset.
%:The following example prints "Exercise set number 1" and "Exercise set number 2" on the top of each set
%:!\At\StartBuildset{
%:! Exercise set number \setName
%:!}
%:! %... \makesets here ...%
%:!\begin{document}
%:! \buildset{1}{myexercise}
%:! \buildset{2}{myexercise}
%:!\end{document}
%:-

  \xdef\setName{#2}
  %% Warnins if the set doesn't exist
  \@ifundefined{setlist@#2}{
    \@latex@error{Couldn't find set #2. Did you remember to do \string\makeset{#2}{}? }
    \stop
  }{}
  %% Sets the current setlist from the variable
  %% generated in makeset
  \edef\setlist{\csname setlist@#2\endcsname}
  \if\@spriteMode\isFalse
    \Trigger\StartBuildset
  \fi
  %% Loop through list
  \foreach \exerciseFileInfo in \setlist{
    \def\continueLoop{\isTrue}
    % \inspw\exerciseFileInfo
    %% ppList is -1 if it's not a list
    \gdef\ppList{-1}
    %% Counter used for iterating over partproblems
    %% (Cant' use partproblemcounter since some of them might be excluded)
    \setcounter{metacounter}{1}
    %% Checking whether we have optional args
    %% I.e. one of the arguments are sent via \exclude
    %% And then send it to \redef
    \StrLeft{\exerciseFileInfo}{1}[\firstchar]%
    \if[\firstchar
      \ea\redef\exerciseFileInfo\relax
      \def\continueLoop{\isTrue}
    \else\if?\firstchar
        \expandafter\@secondoftwo\exerciseFileInfo
      \def\continueLoop{\isFalse}
    \else
        \redef{\exerciseFileInfo}{normal}
        \def\continueLoop{\isTrue}
    \fi\fi
    \if\continueLoop\isTrue

    %% TRIGGER EVERTYHING
%:$triggers.=\Trigger\InputExercise:\\ Triggers before a file is included\\\

%:$triggers.=\Trigger\BeginProblem:\\ Triggers before a file is included, but only if problem headers are to be written (no [nohead] given)\\

%:$triggers.=\Trigger\EndProblem:\\ Triggers right after problem is included if [nohead] \emph{not} given\\

%:$triggers.=\Trigger\BeginBuildset:\\ Triggers right before a set has begun building (not if \dac{sprite} is used). You might want to put your set-header here\\

%:$triggers.=\Trigger\EndBuildset:\\ Triggers when a set has stopped building (not if \dac{sprite} is used)\\

    \Trigger\InputExercise
    \if\nohead\isFalse
      \if\@spriteMode\isFalse
        \Trigger\BeginProblem
      \fi
    \fi
    %% \VeryBeginProblem is only for stuff that
    %% is intended to be a part of the problem
    %% e.g. problem header is using this.
    \if\nohead\isFalse\Trigger\VeryBeginProblem\fi
    \if\@spriteMode\isTrue\textbf{\exerciseFile.tex\\}\fi
    % \inspw\nohead
    %% \incl = \ input because otherwise latexpanded would try.
    %% to input the file
    \incl{\exercisesDir/\exerciseFile}
    %% More triggers
    \if\nohead\isFalse\Trigger\EndProblem\fi
    \fi
  }
  \if\@spriteMode\isFalse
    \Trigger\EndBuildset
  \fi
}
