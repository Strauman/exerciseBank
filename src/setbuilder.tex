%!TEX root = main.tex
\let\ea = \expandafter
\newcounter{metacounter}
\def\emptyList{-1}

\begingroup\lccode`\|=`\\
\lowercase{\endgroup\def\removebs#1{\if#1|\else#1\fi}}
\newcommand{\macroname}[1]{\expandafter\removebs\string#1}

\gdef\ifppMode#1{
  \def\mname{\macroname{#1}}
  \if\mname\ppMode
}
\gdef\isppMode#1#2{
  \edef\mname{\macroname{#1}}
  \if{\macroname{#1}}\ppMode#2\fi
}
\gdef\@noneofone#1{}
\gdef\@noneOfTwo#1#2{}

%%% NOT WORKING
\gdef\@ifppMode#1{%
% \edef\mname{\macroname{#1}}
\ifnum\pdfstrcmp{\macroname{#1}}{\ppMode}=\z@%
\expandafter\@firstofone%
\else%
\expandafter\@noneofone%
\fi%
}%
\def\pm@Exclude{exclude}
\def\pm@Select{select}

%% Deciding whether problem (and accompanied solution) should be shown
\let\ipm\@ifppMode
\let\T\isTrue
\let\F\isFalse
\At\DecideProblemDisplay{
  \if\ppList\emptyList
    \xdef\DisplayProblem{\ipm\exclude\T\ipm\select\F}
  \else
    \isin{\ppList}{\themetacounter}{
      \xdef\DisplayProblem{\ipm\exclude\F\ipm\select\T\ipm\normal\T}
    }{
      \xdef\DisplayProblem{\ipm\exclude\T\ipm\select\F\ipm\normal\T}
    }
  \fi
  \inspw\DisplayProblem
  \stepcounter{metacounter}
}
%% Generates sets that can be iterated over
\gdef\makeset#1#2{
  \ea\gdef\csname setlist@#1\endcsname{#2}
}
%% Sets the variables \ppList and \exerciseFile based on the current set
\newcommand{\redef}[3][{-1}]{
  \gdef\ppList{#1}
  \gdef\exerciseFile{#2}
  \gdef\ppMode{#3}
}
%% Converts {A}{1,2,3} into [{1,2,3}]{A}{exclude} such that it can be sent
%% as optional arguments to redef. The last is set as ppMode (exclude/select/mix)
\newcommand{\exclude}[2]{[{#2}]{#1}{exclude}}
\newcommand{\select}[2]{[{#2}]{#1}{select}}

%% Build one exercise
\gdef\buildex#1{
  \makeset{#1}{#1}
  \buildset{#1}
}
%%Logic for building a set
\gdef\@countIntros{\isFalse}
\newcommand\buildset[2][]{
  \def\moarg{#1}
  \def\argToShowIntro{intro}
  \ifx\moarg\argToShowIntro%
    \gdef\@countIntros{\isTrue}
    \@latex@warning{Counting intros!}
  \fi
  %% Setting the global setName
  \xdef\setName{#2}
  %% Warnins if the set doesn't exist
  \@ifundefined{setlist@#2}{
    \@latex@error{Couldn't find set #2. Did you remember to do \string\makeset{#2}{}? }
    \stop
  }{}
  %% Sets the current setlist from the variable
  %% generated in makeset
  \edef\setlist{\csname setlist@#2\endcsname}
  \Trigger\StartBuildset
  %% Loop through list
  \foreach \exerciseFileInfo in \setlist{
    %% ppList is -1 if it's not a list
    \gdef\ppList{-1}
    %% Counter used for iterating over partproblems
    %% (Cant' use partproblemcounter since some of them might be excluded)
    \setcounter{metacounter}{1}
    %% Checking whether we have optional args
    %% I.e. one of the arguments are sent via \exclude
    %% And then send it to \redef
    \StrLeft{\exerciseFileInfo}{1}[\firstchar]%
    \if[\firstchar
      \ea\redef\exerciseFileInfo\relax
    \else
      \redef{\exerciseFileInfo}{normal}
    \fi
    %% TRIGGER EVERTYHING
    \Trigger\InputExercise
    \Trigger\BeginProblem
    %% The two above are meant to be aliases
    %% The one below \VeryBeginProblem is only for stuff that
    %% is intended to be a part of the problem
    %% e.g. problem header is using this.
    \Trigger\VeryBeginProblem
    %% \incl = \input because otherwise latexpanded would try.
    %% to input the file
    \incl{\exercisesDir/\exerciseFile}
    %% More triggers
    \Trigger\EndProblem
    \Trigger\EndInputExercise
  }
  \Trigger\EndBuildset
}
