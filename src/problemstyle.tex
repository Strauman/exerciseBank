%!TEX root = main.tex
% This file contains \At-commands that are responsible for formatting
% exercise headers and exercise-related styles.
\makeatletter
%:§margs
%:Note that these are all \!emph{\!\textbf{lengths}}
%:and should be used as e.g.
%:!\setlength{\pMarginBelow}
%:-
%:=\pMarginBelow
%:Distance below Problem \# header
\newlength{\pMarginBelow}
%:=\pMarginAbove
%:Distance above Problem \# header
\newlength{\pMarginAbove}
%:=\pMarginLeft
%: Problem header: distance from the default left margin
\newlength{\pMarginLeft}
%:=\ppMarginBelow
%: Part problem: distance from the end of the part problem to the next item
\newlength{\ppMarginBelow}
%:=\ppMarginAbove
%: Part problem: distance above the start of the part problem to the previous item
\newlength{\ppMarginAbove}
%:=\ppMargin
%: Part problem: how far away from the text the part problem labels are.
\newlength{\ppMargin}
%:=\introMargin
%: The offset of margins for intros
\newlength{\introMargin}
\newlength{\solutionMarginLeft}
\newlength{\solutionMarginAbove}
%:-

\edef\defaultLeftMargin{\the\dimexpr1in+\hoffset}



\setlength{\ppMargin}{0.5em}
\setlength{\pMarginLeft}{-\ppMargin-2.5em}
\setlength{\solutionMarginLeft}{\ppMargin}
\setlength{\solutionMarginAbove}{1em}
\setlength{\pMarginBelow}{0em}
\setlength{\pMarginAbove}{\baselineskip}
\setlength{\introMargin}{-1.5em}
\setlength{\ppMarginBelow}{0em}
\setlength{\ppMarginAbove}{0em}


\setlength\parindent{0pt}
\newbox\ppmarkbox
\newlength\markskip
\setlength\markskip{4\baselineskip}

\def\solMargin{\dimexpr \ppMargin\relax}
\def\vsSize{1em}
\def\vs{\vspace{\vsSize}}
%:§count
%:\!docCounter{problemcounter}-counter holds the current problem number and
%:\!docCounter{partproblemcounter}-counter holds the current partproblem \!emph{number}.
%:-
\newcounter{problemcounter}
\setcounter{problemcounter}{0}
\newcounter{partproblemcounter}
\At\VeryBeginProblem{%
	\if\exbank@opt@tightenparagraphs\@isTrue\relax%
	\ifexbank@if@needspace\needspace{\exbank@opt@problemneedspace}\fi%
	\vskip-2\baselineskip\relax%
	\fi%
	\stepcounter{problemcounter}%
	\setcounter{partproblemcounter}{0}%
	\vspace*{\pMarginAbove}%
		% \@dlog{YO}%
		% \global\exbset@nextprob@headerfalse%
  \strut\vadjust{\vbox to 0pt{\if\exbank@opt@doMargins\@isTrue\hskip\pMarginLeft\fi{\exbank@opt@problemHeader}\vss}}\par%
	\vspace*{\the\dimexpr\baselineskip+\pMarginBelow}%
}
\At\EndProblem{%
\tighten@paragraph%
}%
% For executing the tag only when entered hmode

\At\VeryBeginPartproblem{%
\@dinfo{Triggered Beginning Part Problem (\string\VeryBeginPartproblem)}%
	\stepcounter{partproblemcounter}%%
	% \bgroup%
	% If we should display the meta counter, then%
	\@dinfo{Generating title for part problem}%
	\gdef\exb@prePPHead{}%
	\gdef\exb@postPPHead{}%
	\if\@displayMetaCounter\@isTrue\relax%%
		\gdef\exb@prePPHead{{\Large\themetacounter}:}%
	\fi%
	\if\exb@showtags\isTrue%
		% \exb@printCurrentTags defined in packageoptions.tex
		\gdef\exb@postPPHead{\exb@printCurrentTags}%
	\fi%
%:$triggers.=\Trigger\PartProblemHeaderSuffix:\\ Triggers after the part problem header.
%:$triggers.= anything added to this trigger will happen within the header

\ifnum\pdfstrcmp{\exbank@opt@doMargins}{\@isTrue}=\z@\relax%
% \if\exbank@opt@doMargins\@isTrue
%TODO: BADLINE BELOW:
\newbox\nobox%
\bgroup
\let\exb@partProblemHeader\exbank@opt@partProblemHeader
\ifexb@b@nextprob@header\relax
	\global\exb@b@nextprob@headerfalse
	\addtocounter{partproblemcounter}{-1}
	\let\exb@partProblemHeader\exb@nextprob@header%
\fi
\gdef\exb@pp@lefttag{\leavevmode{\smash{\llap{{\exb@prePPHead\exb@partProblemHeader\Trigger\PartProblemHeaderSuffix}\hskip\ppMargin}\exb@postPPHead}}}%
\else%
\gdef\exb@pp@lefttag{{\exb@partProblemHeader\Trigger\PartProblemHeaderSuffix}}%
\fi%
\bgroup
\AtNextPar{\exb@pp@lefttag\global\let\exb@pp@lefttag\relax}%
\ignorespaces}%
\At\EndPartproblem{%
	% \egroup%
	\vspace*{\ppMarginBelow}%
	\tighten@paragraph\par%
}

\At\BeginSolution{\hfill\break\vspace*{\solutionMarginAbove}{\exbank@opt@solutionHeader}}
\At\EndSolution{}
