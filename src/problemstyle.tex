%!TEX root = main.tex
% This file contains \At-commands that are responsible for formatting
% exercise headers and exercise-related styles.
\makeatletter
%:§margs
%:Note that these are all \!emph{\!\textbf{lengths}}
%:and should be used as e.g.
%:!\setlength{\pMarginBelow}
%:-
%:=\pMarginBelow
%:Distance below Problem \# header
\newlength{\pMarginBelow}
%:=\pMarginAbove
%:Distance above Problem \# header
\newlength{\pMarginAbove}
%:=\pMarginLeft
%: Problem header: distance from the default left margin
\newlength{\pMarginLeft}
%:=\ppMarginBelow
%: Part problem: distance from the end of the part problem to the next item
\newlength{\ppMarginBelow}
%:=\ppMarginAbove
%: Part problem: distance above the start of the part problem to the previous item
\newlength{\ppMarginAbove}
%:=\ppMargin
%: Part problem: how far away from the text should the part problem labels be
\newlength{\ppMargin}
\newlength{\solutionMarginLeft}
\newlength{\solutionMarginAbove}
%:-

\edef\defaultLeftMargin{\the\dimexpr1in+\hoffset}



\setlength{\pMarginLeft}{-2em}
\setlength{\ppMargin}{-0.5em}
\setlength{\solutionMarginLeft}{\ppMargin}
\setlength{\solutionMarginAbove}{1em}
\setlength{\pMarginBelow}{1em}
\setlength{\pMarginAbove}{\baselineskip}

\setlength{\ppMarginBelow}{\baselineskip}
\setlength{\ppMarginAbove}{0em}


\setlength\parindent{0pt}

\newcommand{\@atMargin}[2]{\strut\vadjust{\@domark{#1}{#2}}}

\newcommand{\@domark}[2]{%
    \hskip#2\relax\vbox to 0pt{
      \kern-\dp\strutbox
      \smash{\llap{#1}}
      \vss
    }%
}

\def\solMargin{\dimexpr \ppMargin\relax}
\def\vsSize{1em}
\def\vs{\vspace{\vsSize}}
%:§count
%:\!docCounter{problemcounter}-counter holds the current problem number and
%:\!docCounter{partproblemcounter}-counter holds the current partproblem \!emph{number}.
%:-
\newcounter{problemcounter}
\setcounter{problemcounter}{0}
\newcounter{partproblemcounter}

\At\VeryBeginProblem{%
	\stepcounter{problemcounter}%
	\setcounter{partproblemcounter}{0}%
	\vspace*{\pMarginAbove}%
		\if\exbank@opt@doMargins\@isTrue\hskip\pMarginLeft\fi%
    {\exbank@opt@problemHeader}%
	\vspace*{\pMarginBelow}%
}
\At\EndProblem{%
\tighten@paragraph%
}
\At\VeryBeginPartproblem{%
	\stepcounter{partproblemcounter}%%
	\bgroup%
	% If we should display the meta counter, then%
	\if\@displayMetaCounter\@isTrue\relax%%
		\ex@before\exbank@opt@partProblemHeader{{\Large\themetacounter}:}%
	\fi%
  \if\exbank@opt@doMargins\@isTrue\relax
  \par\@atMargin{{\exbank@opt@partProblemHeader}}{\ppMargin}\ignorespaces\else{\exbank@opt@partProblemHeader}\fi%
}%
\At\EndPartproblem{%
	\egroup\tighten@paragraph%
	\vspace*{\pMarginBelow}%
}

\At\BeginSolution{\hfill\break\vspace*{\solutionMarginAbove}{\exbank@opt@solutionHeader}}
\At\EndSolution{}
