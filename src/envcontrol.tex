%!TEX root = main.tex
% This file contains everything to do with controlling environments
% except from outsourcing stuff with \At and \Trigger:
% Namely deciding whether or not a problem, intro and/or solution should
% displayed

\makeatletter

\gdef\isFalse{0}
\gdef\isTrue{1}
\gdef\DisplayProblem{\isTrue}
\gdef\@displayMetaCounter{\isFalse}

%%%% NB: Difference between \DisplaySolution and \DisplaySolutions
\gdef\@DisplaySolutions{\isFalse}
%%NB: DOC for \DisplaySolutions are moved down
\gdef\DisplaySolutions{\xdef\@DisplaySolutions{\isTrue}\@latex@warning{Showing solutions}}
\AtBeginDocument{
  \if\@DisplaySolutions\isFalse
    \@latex@warning{Hiding solutions. Show them with \string\DisplaySolutions}
  \fi
}
\global\let\do@ProcessCutFile = \ProcessCutFile
%% Problems
%:$triggers.=\Trigger\BeginPartproblem:\\ Triggers before a partproblem is inserted\\
%:$triggers.=\Trigger\VeryBeginPartproblem:\\ Triggers right after \BeginPartproblem. This is so that the user can do stuff before the actual headers start. The partproblem headers are invoked by \At\VeryBeginPartproblem\\
\gdef\showhideproblem#1{%
  \if\DisplayProblem\isFalse
    \def\ProcessCutFile{}
  \else
    \if\@displayMetaCounter\isTrue\relax{\Large\themetacounter}\fi
    #1
  \fi
}

%:§env
%:=\\begin{problem}
%:Inside the \keyRef{exercise directory}, you keep your exercises. Inside the exercise file you'd use a problem environment to write your partproblems. It might be a little confusing that you're using \begin{problem} instead of \begin{partproblem} when you're writing a partproblem, but it's less typing.
%\!begin{marker}\end{problem} has to be on it's own line without any leading spaces!\!end{marker}
% :-
\generalcomment{problem}{
\makeatletter
  %%%% NB: Difference between \DisplaySolution and \DisplaySolutions
  \edef\DisplaySolution{\@DisplaySolutions}
  \stepcounter{metacounter}
  %% BeginProblemHard is before regardless whether
  %% the problem is included or not.
  \Trigger\DecideProblemDisplay
  \begingroup
     \showhideproblem{
        % If the user haven't turned off part problems
        \if\exbank@opt@partProblems\isTrue
            \Trigger\BeginPartproblem
            \Trigger\VeryBeginPartproblem
        \else
            \Trigger\BeginProblem
            \Trigger\VeryBeginProblem
        \fi
      }
  }{
    \if\DisplayProblem\isFalse\else
      \if\exbank@opt@partProblems\isTrue
        \Trigger\EndPartproblem
      \else
        \Trigger\EndProblem
      \fi
    \fi
  \endgroup
}

%:§env
%:=\\begin{solution}
%: Things inside here is only visible if \refCom{DisplaySolutions} are given before \begin{document}
%: \!begin{marker}\end{solution} has to be on it's own line without any leading spaces!\!end{marker}
%:-
%:=\DisplaySolutions
%:Turns on the solutions, so they are shown.
%:-
%% Solutions
\generalcomment{solution}
{
\Trigger\AtBeginSolutionHard
\begingroup
  \if\@DisplaySolutions\isTrue
    \if\DisplayProblem\isFalse
      \xdef\DisplaySolution{\isFalse}
    \fi
  \fi
  % \inspw{\DisplaySolution}
  \if\DisplaySolution\isTrue
    \Trigger\BeginSolution
  \else
    \def\ProcessCutFile{}
  % \begingroup
  % \edef\tmp{\def\noexpand\CommentCutFile{answer.tex}}
  % \tmp
    % \def\ProcessCutFile{\do@ProcessCutFile}
  \fi
}{
% \input{\CommentCutFile}
\if\DisplaySolution\isTrue
\Trigger\EndSolution
\fi

\Trigger\EndSolutionHard
\endgroup
}
%% Problem introductions
%:§env
%:=\\begin{intro}
%:Sometimes you'd want to introcude your exercises and tell a little bit about it. Maybe have a figure there also. Those things should go inside this environment. This can be treated as a problem in terms of counting. See \refCom{makeset} for more info.
%\!begin{marker}\end{intro} has to be on it's own line without any leading spaces!\!end{marker}
%:-
\generalcomment{intro}{
  %% Decide wether to treat intro as problem in
  %% include/exclude (except from \Trigger\BeginProblem ofc)
  \if\@countIntros\isTrue
    \stepcounter{metacounter}
    \Trigger\DecideProblemDisplay
    \begingroup
    \if\@spriteMode\isTrue
      \if\introarg\isTrue
        \stepcounter{partproblemcounter}
        {\exbank@opt@partProblemHeader}
      \fi
    \fi
    \showhideproblem{\Trigger\BeginIntro}
  \fi
}{
  \if\@countIntros\isTrue
    \Trigger\EndIntro
    \endgroup
  \fi
  \vspace*{1em}\tighten@paragraph
}
