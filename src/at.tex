%!TEX root = main.tex
% This file contains definitions of the \At and \Trigger command

%:§ref
\makeatletter
\newif\ifat@isrigid
%% Adds macro to queue
\let\ea = \expandafter
\begingroup\lccode`\|=`\\
\lowercase{\endgroup\def\removebs#1{\if#1|\else#1\fi}}
\ifcsname at@verbose\endcsname
	\global\def\@triggerLog#1{\@latex@warning{--\string\TRIGGER: #1}}%
\else
	\global\let\@triggerLog\@gobble%
\fi
%:This package also includes some extra stuff. For example the \At and \Trigger
%:!TOC
%:=\At{AnyMacro}
%:Here you can send any macro because it isn't evaluated! For example \At\BeginSomething is fine and even if \BeginSomething is not defined. Also and when using \Trigger it just ignores it if it didn't exist. It's pretty similar in function as to \AtBeginDocument.
%:! \At\BeginSomething{DoSomething}
%:! Which is triggered with
%:! \Trigger\BeginSomething, this evaluates to DoSomething
%:-
%% Usage: \At\BeginSomething (\BeginSomething) doesn't have to be defined
\newcommand{\At}[2]{%
	\edef\mname{\exbank@macroname{#1}}%
	\ifcsname At@\mname\endcsname%
		\ea\g@addto@macro\csname At@\mname\endcsname{#2}%
	\else%
    \ifat@isrigid
      \ea\gdef\csname Rigid@At@\mname\endcsname{#2}%
    \else
      \ea\gdef\csname At@\mname\endcsname{#2}%
    \fi%
		% \AtEndDocument{%
			% \expandafter\let\csname At@\mname\endcsname\relax%
		% }
	\fi%
	\global\at@isrigidfalse%
}
%:=\@rigid
%:Used to make \At so that the contents won't be deleted
%:with \ClearHook. Note that the necessary hooks might not be
%: registered as rigid. Thus show caution when deleting hooks
%:-
\let\@rigid\at@isrigidtrue

%% Triggers queue generated by \At
%% Usage: \Trigger\BeginSomething (\BeginSomething) doesn't have to be defined
%:§triggers=Triggers
%:=\Trigger{Any Macro}
%: See \refCom{At}\\
%: Available triggers:\\
%:$$triggers
%:-
\newcommand{\Trigger}[1]{%
	\edef\mname{\exbank@macroname{#1}}%
  % First trigger rigid
  \ea\@ifundefined{Rigid@At@\mname}{}{%
		\@triggerLog{\mname}\csname Rigid@At@\mname\endcsname%
	}%
	\ea\@ifundefined{At@\mname}{}{%
		\@triggerLog{\mname}\csname At@\mname\endcsname%
	}%
}
%:=\exb@ClearHook
%: Deletes all information from a hook.
%: Note that if preceded by \rigid, then the
%: ENTIRE hook will be cleared.
%: Note that the necessary hooks might not be
%: registered as rigid. Thus show caution when deleting hooks
%:-
\newcommand{\exb@ClearHook}[1]{%
	\edef\mname{\exbank@macroname{#1}}%
	\expandafter\let\csname At@\mname\endcsname\relax%
  \ifat@isrigid
    \expandafter\let\csname Rigid@At@\mname\endcsname\relax%
  \fi
	\global\at@isrigidfalse%
}
\makeatother
